<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RT æ£€æµ‹</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #e4e9f2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
        }
        .result-card { 
            margin-bottom: 10px; 
            border-left: 4px solid #ccc; 
            padding: 10px;
            background-color: #fff;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border-radius: 4px;
            font-family: Consolas, monospace;
            font-size: 14px;
            line-height: 1.5em;
        }
        .success { border-left-color: #28a745; }
        .error { border-left-color: #dc3545; }
        .loading { display: none; }
        .btn { 
            min-width: 120px;
            padding: 8px 16px;
        }
        .card {
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            border: none;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 12px;
        }
        .card-header {
            border-bottom: 1px solid rgba(0,0,0,0.1);
            background: transparent;
            padding: 15px 20px;
            font-size: 1.1rem;
        }
        .card-body {
            position: relative;
            padding: 0;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        .input-container {
            position: relative;
            flex: 1;
            height: 400px;
            margin-bottom: 15px;
            border: 1px solid #ced4da;
            border-radius: 8px;
            overflow: hidden;
            display: flex;
        }
        textarea {
            height: 400px !important; /* å¢åŠ 20%é«˜åº¦ */
            min-height: unset !important;
            resize: none;
            font-family: monospace;
            border-radius: 8px;
            border: 1px solid rgba(0,0,0,0.1);
            padding: 15px;
            background: rgba(255, 255, 255, 0.9);
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        textarea:focus {
            box-shadow: 0 0 0 3px rgba(13,110,253,0.15);
            border-color: #0d6efd;
        }
        #results {
            height: 400px;
            overflow-y: auto;
            padding-right: 8px;
            font-family: Consolas, monospace;
            font-size: 14px;
            line-height: 1.5em;
        }
        .container {
            max-width: 1400px; /* å¢åŠ å®¹å™¨å®½åº¦ */
            padding: 0 30px;
        }
        .btn-group {
            display: flex;
            justify-content: center;  /* æ°´å¹³å±…ä¸­ */
            align-items: center;      /* å‚ç›´å±…ä¸­ */
            gap: 10px;
            padding: 15px;
            background: #fff;
            border-top: 1px solid #e9ecef;
            margin-top: auto;
        }
        .alert {
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            border-radius: 8px;
            border: none;
            font-family: Consolas, monospace;
            font-size: 14px;
            line-height: 1.5em;
        }
        #results::-webkit-scrollbar {
            width: 8px;
        }
        #results::-webkit-scrollbar-track {
            background: rgba(241,241,241,0.5);
            border-radius: 4px;
        }
        #results::-webkit-scrollbar-thumb {
            background: rgba(136,136,136,0.5);
            border-radius: 4px;
        }
        #results::-webkit-scrollbar-thumb:hover {
            background: rgba(85,85,85,0.7);
        }
        .btn {
            border-radius: 6px;
            transition: all 0.2s;
        }
        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .row {
            margin: 0 -20px;
        }
        .col-md-6 {
            padding: 0 20px;
        }
        .line-numbers {
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 3em;
            text-align: right;
            color: #999;
            font-family: Consolas, monospace;
            font-size: 14px;
            line-height: 1.5em;
            padding: 8px 8px 8px 0;
            user-select: none;
            pointer-events: none;
            background: #f8f9fa;
            border-right: 1px solid #e9ecef;
            box-sizing: border-box;
            z-index: 1;
            white-space: pre;
            overflow: hidden;
        }
        
        #inputTokens {
            width: 100%;
            height: 100%;
            padding: 8px 10px 8px 3.5em !important;
            font-family: Consolas, monospace;
            font-size: 14px;
            line-height: 1.5em;
            resize: none;
            white-space: pre !important;
            overflow-y: auto;
            background-color: transparent;
            position: relative;
            z-index: 0;
            border: none;
            box-sizing: border-box;
        }

        #inputTokens:focus {
            outline: none;
            box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
        }

        .card-body {
            position: relative;
            padding: 0;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .btn-group {
            padding: 15px;
            background: #fff;
            border-top: 1px solid #e9ecef;
            margin-top: auto;
        }

        /* ä¼˜åŒ–æ»šåŠ¨æ¡æ ·å¼ */
        #inputTokens::-webkit-scrollbar {
            width: 8px;
        }

        #inputTokens::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        #inputTokens::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }

        #inputTokens::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }

        /* å“åº”å¼è°ƒæ•´ */
        @media (max-width: 768px) {
            .line-numbers {
                width: 2.5em;
            }
            #inputTokens {
                padding-left: 3em !important;
                font-size: 13px;
            }
        }

        /* ä¿®æ”¹æŒ‰é’®å®¹å™¨çš„æ ·å¼ */
        .button-container {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;  /* å¢åŠ æŒ‰é’®ä¹‹é—´çš„é—´è· */
            padding: 20px;
            margin-top: 20px;
        }

        .button-container .btn {
            min-width: 140px;     /* ç»Ÿä¸€æŒ‰é’®å®½åº¦ */
            height: 45px;         /* ç»Ÿä¸€æŒ‰é’®é«˜åº¦ */
            font-size: 16px;      /* ç»Ÿä¸€å­—ä½“å¤§å° */
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            transition: all 0.2s;
            font-weight: 500;
        }

        /* è”šè“è‰²æŒ‰é’®æ ·å¼ */
        .btn-blue {
            background-color: #1e90ff;
            border-color: #1e90ff;
            color: white;
        }
        .btn-blue:hover {
            background-color: #187bdb;
            border-color: #187bdb;
            color: white;
        }

        /* ç»¿è‰²æŒ‰é’®æ ·å¼ */
        .btn-green {
            background-color: #2ecc71;
            border-color: #2ecc71;
            color: white;
        }
        .btn-green:hover {
            background-color: #27ae60;
            border-color: #27ae60;
            color: white;
        }

        /* ä¿®æ”¹å¡ç‰‡å®¹å™¨çš„æ ·å¼ */
        .row {
            margin-bottom: 0;  /* ç§»é™¤åº•éƒ¨é—´è· */
        }

        /* ç¡®ä¿å¡ç‰‡é«˜åº¦ä¸€è‡´ */
        .card {
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .card-body {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        h1 {
            font-size: 1.8rem;
            color: #333;
            font-weight: 600;
            margin-bottom: 1.5rem !important;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
        }

        @keyframes textFade {
            0%, 40% {
                opacity: 1;
                transform: translateY(0);
            }
            45%, 50% {
                opacity: 0;
                transform: translateY(-20px);
            }
            55%, 95% {
                opacity: 1;
                transform: translateY(0);
            }
            100% {
                opacity: 1;
                transform: translateY(0);
            }
        }

        #loadingText {
            animation: textFade 2s linear;
            min-height: 2em;
        }

        #notice {
            min-width: 280px;
            transform: translateX(100%);
            animation: slideInOut 4s ease-in-out;
            border-radius: 12px;
            border-left: 4px solid #2ecc71;
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(10px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        @keyframes slideInOut {
            0% {
                transform: translateX(100%);
                opacity: 0;
            }
            5% {
                transform: translateX(0);
                opacity: 1;
            }
            90% {
                transform: translateX(0);
                opacity: 1;
            }
            100% {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        #notice ul li {
            margin-bottom: 8px;
            color: #555;
            font-size: 14px;
            display: flex;
            align-items: center;
            padding: 4px 0;
        }

        #notice h5 {
            color: #2ecc71;
            font-weight: 600;
            font-size: 16px;
            margin-bottom: 12px;
        }

        #notice i {
            color: #2ecc71;
        }

        .memo-item {
            border-left: 4px solid #2ecc71;
            margin-bottom: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            transition: all 0.3s ease;
        }

        .memo-item:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        .memo-header {
            position: relative;  /* ä¸ºç»å¯¹å®šä½çš„ä¿å­˜æŒ‰é’®æä¾›å‚è€ƒ */
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 4px;
            transition: background-color 0.2s;
            min-height: 45px;  /* ç¡®ä¿æœ‰è¶³å¤Ÿçš„é«˜åº¦å®¹çº³æŒ‰é’® */
        }

        .memo-header:hover {
            background: #e9ecef;
        }

        .memo-body {
            transition: all 0.3s ease;
        }

        .memo-time {
            font-size: 0.85rem;
            color: #666;
        }

        .memo-content {
            min-height: 60px;
            padding: 8px;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            background: white;
        }

        .memo-actions {
            margin-top: 10px;
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }

        .memo-actions button {
            padding: 4px 8px;
            font-size: 0.85rem;
        }

        .memo-time i {
            transition: transform 0.3s ease;
        }

        .btn-group .btn {
            transition: all 0.2s;
        }

        .btn-group .btn:hover {
            transform: translateY(-1px);
        }

        .btn-danger {
            background-color: #dc3545;
            border-color: #dc3545;
        }

        .btn-danger:hover {
            background-color: #c82333;
            border-color: #bd2130;
        }

        .memo-preview {
            flex: 1;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.95rem;
            color: #333;
        }

        .memo-time {
            font-size: 0.8rem;
            color: #666;
            white-space: nowrap;
            margin-left: 15px;
        }

        .memo-content {
            min-height: 100px;
            font-size: 0.95rem;
            line-height: 1.5;
            padding: 12px;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            background: white;
            resize: vertical;
        }

        .memo-content:focus {
            outline: none;
            border-color: #80bdff;
            box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25);
        }

        .memo-preview {
            flex: 1;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 500;  /* è®©æ ‡é¢˜æ›´æ˜æ˜¾ */
        }

        input[type="text"] {
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 8px 12px;
            font-size: 1rem;
            font-weight: 500;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: #80bdff;
            box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25);
        }

        .memo-body {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out, opacity 0.3s ease-out, margin 0.3s ease-out;
            opacity: 0;
            margin-top: 0;
        }

        .memo-body.expanded {
            max-height: 1000px; /* è¶³å¤Ÿå¤§çš„é«˜åº¦ä»¥å®¹çº³å†…å®¹ */
            opacity: 1;
            margin-top: 10px;
        }

        .memo-header i {
            transition: transform 0.3s ease;
        }

        .memo-header i.rotated {
            transform: rotate(180deg);
        }

        .btn-purple {
            background-color: #6f42c1;
            border-color: #6f42c1;
            color: white;
        }

        .btn-purple:hover {
            background-color: #5a32a3;
            border-color: #5a32a3;
            color: white;
        }

        .btn-purple i {
            transition: transform 0.3s ease;
        }

        .btn-purple.active i {
            transform: rotate(180deg);
        }

        .memo-container {
            transition: all 0.3s ease-in-out;
            opacity: 0;
            transform: translateY(-20px);
        }

        .memo-container.show {
            opacity: 1;
            transform: translateY(0);
        }

        .memo-details {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out, opacity 0.3s ease-out;
            opacity: 0;
        }

        .memo-details.expanded {
            max-height: 1000px;
            opacity: 1;
            padding: 15px 0;
        }

        .memo-item {
            overflow: hidden;  /* ç¡®ä¿åŠ¨ç”»ä¸ä¼šæº¢å‡º */
        }

        /* æ·»åŠ å¤‡å¿˜å½•å†…å®¹çš„è¡Œå·æ ·å¼ */
        .memo-content-container {
            position: relative;
            width: 100%;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            background: white;
            min-height: 100px;
        }

        .memo-line-numbers {
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 3em;
            text-align: right;
            color: #999;
            font-family: Consolas, monospace;
            font-size: 14px;
            line-height: 21px; /* è®¾ç½®å›ºå®šè¡Œé«˜ */
            padding: 12px 8px 12px 0; /* è°ƒæ•´ä¸Šä¸‹å†…è¾¹è· */
            user-select: none;
            pointer-events: none;
            background: #f8f9fa;
            border-right: 1px solid #e9ecef;
            box-sizing: border-box;
            z-index: 1;
            white-space: pre;
            overflow: hidden;
        }

        .memo-content {
            width: 100%;
            padding: 12px 12px 12px 3.5em !important; /* è°ƒæ•´å†…è¾¹è·ä¸è¡Œå·å¯¹é½ */
            font-family: Consolas, monospace;
            font-size: 14px;
            line-height: 21px; /* è®¾ç½®ç›¸åŒçš„è¡Œé«˜ */
            resize: vertical;
            white-space: pre-wrap !important;
            overflow-y: auto;
            background-color: transparent;
            position: relative;
            z-index: 0;
            min-height: 100px;
        }

        .memo-preview {
            flex: 1;
            margin-right: 80px;  /* ä¸ºä¸­é—´çš„ä¿å­˜æŒ‰é’®ç•™å‡ºç©ºé—´ */
        }
    </style>
</head>
<body class="bg-light">
    <div class="container py-4">
        <h1 class="text-center mb-4">RT æ£€æµ‹ è·å–</h1>
        
        <div class="row g-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-white fw-bold">è¾“å…¥RTï¼ˆæ¯è¡Œä¸€ä¸ªï¼‰</div>
                    <div class="card-body">
                        <div class="input-container">
                            <div class="line-numbers" id="lineNumbers"></div>
                            <textarea id="inputTokens" class="form-control" placeholder="è¯·è¾“å…¥RTï¼Œæ¯è¡Œä¸€ä¸ªï¼Œå•æ¬¡äº”ä¸ªï¼Œé˜²æ­¢å¤±è´¥..."></textarea>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-white fw-bold">æ£€æµ‹ç»“æœ</div>
                    <div class="card-body">
                        <div id="results"></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="button-container">
            <button onclick="window.open('https://token.oaifree.com/auth', '_blank')" class="btn btn-blue">è·å–</button>
            <button id="checkButton" class="btn btn-blue">æ£€æµ‹</button>
            <button id="copyValidRTButton" class="btn btn-green">å¤åˆ¶æœ‰æ•ˆRT</button>
            <button id="copyValidATButton" class="btn btn-green">å¤åˆ¶æœ‰æ•ˆAT</button>
            <button id="toggleMemoButton" class="btn btn-purple" onclick="toggleMemoContainer()">
                å¤‡å¿˜å½•
                <i class="fas fa-chevron-down ms-1"></i>
            </button>
        </div>
        <div class="memo-container mt-4" id="memoContainer" style="display: none;">
            <div class="card">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">å¤‡å¿˜å½•</h5>
                    <div class="btn-group">
                        <button class="btn btn-sm btn-primary me-2" onclick="addMemo()">æ–°å¢å¤‡å¿˜</button>
                        <button class="btn btn-sm btn-danger" onclick="clearAllMemos()">æ¸…é™¤å…¨éƒ¨</button>
                    </div>
                </div>
                <div class="card-body" id="memoList">
                    <!-- å¤‡å¿˜å½•åˆ—è¡¨å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>
        </div>
    </div>

    <div id="loading" class="loading position-fixed top-0 start-0 w-100 h-100 bg-dark bg-opacity-50" style="z-index: 1050;">
        <div class="position-absolute top-50 start-50 translate-middle text-white text-center">
            <div class="spinner-border mb-2"></div>
            <div id="loadingText" class="mt-2 fs-5"></div>
        </div>
    </div>

    <div id="notice" class="position-fixed top-0 end-0 p-4 rounded shadow-lg bg-white" style="z-index: 1060; display: none; margin: 20px;">
        <div class="text-start">
            <h5 class="mb-3 d-flex align-items-center">
                <i class="fas fa-info-circle me-2"></i>
                æ³¨æ„äº‹é¡¹
            </h5>
            <ul class="list-unstyled mb-0">
                <li class="mb-2"><i class="fas fa-check-circle me-2 text-success"></i>æ— æ•°æ®å­˜å‚¨</li>
                <li class="mb-2"><i class="fas fa-check-circle me-2 text-success"></i>æ— æ—¥å¿—è®°å½•</li>
                <li class="mb-2"><i class="fas fa-check-circle me-2 text-success"></i>HTTPS ä¼ è¾“</li>
                <li class="mb-2"><i class="fas fa-check-circle me-2 text-success"></i>ä»¤ç‰Œä»…ç”¨äºéªŒè¯</li>
                <li class="mb-2"><i class="fas fa-check-circle me-2 text-success"></i>ä»£ç ç”±<a href="https://www.cursor.com/" target="_blank">Cursor</a>ç”Ÿæˆ (<a href="https://github.com/kepsee/rtck" target="_blank">verceléƒ¨ç½² æºç </a>)</li>
            </ul>
        </div>
    </div>

    <script>
        let lastResults = [];
        let autoSaveTimeout;
        const copy = text => navigator.clipboard.writeText(text).then(() => alert('å¤åˆ¶æˆåŠŸï¼')).catch(err => alert('å¤åˆ¶å¤±è´¥ï¼š' + err));

        const textarea = document.getElementById('inputTokens');
        const lineNumbers = document.getElementById('lineNumbers');

        function updateLineNumbers() {
            const lines = textarea.value.split('\n');
            const numbers = lines.map((_, i) => `${i + 1}`).join('\n');
            lineNumbers.textContent = numbers;
        }

        textarea.addEventListener('scroll', () => {
            lineNumbers.scrollTop = textarea.scrollTop;
        });

        textarea.addEventListener('input', updateLineNumbers);

        // åˆå§‹åŒ–
        updateLineNumbers();

        const resizeObserver = new ResizeObserver(() => {
            requestAnimationFrame(() => {
                adjustTextareaHeight();
                syncScroll();
            });
        });
        resizeObserver.observe(textarea);

        textarea.addEventListener('paste', () => {
            setTimeout(() => {
                updateLineNumbers();
                adjustTextareaHeight();
            }, 0);
        });

        document.getElementById('checkButton').addEventListener('click', async () => {
            const loading = document.getElementById('loading');
            const loadingText = document.getElementById('loadingText');
            const results = document.getElementById('results');
            
            // æ¸…ç†å’ŒéªŒè¯è¾“å…¥
            const tokens = textarea.value.split('\n')
                .map(line => line.trim())
                .filter(line => line.length > 0);

            if (tokens.length === 0) {
                alert('è¯·è¾“å…¥è¦æ£€æµ‹çš„RT');
                return;
            }

            // æ·»åŠ ä»¤ç‰Œæ•°é‡é™åˆ¶æ£€æŸ¥
            if (tokens.length > 5) {
                alert('æ¯æ¬¡æœ€å¤šåªèƒ½æ£€æµ‹5ä¸ªä»¤ç‰Œ');
                return;
            }

            loading.style.display = 'block';
            loadingText.textContent = 'oaiåˆ«æäº†ğŸ™';
            
            // ç­‰å¾…å›ºå®šçš„1.8ç§’
            await new Promise(resolve => setTimeout(resolve, 1800));
            
            try {
                const response = await fetch('/api/check-tokens', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({ tokens })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                lastResults = await response.json();
                
                // æ˜¾ç¤ºç»“æœç»Ÿè®¡
                const validCount = lastResults.filter(r => r.status === 'valid').length;
                results.innerHTML = `
                    <div class="alert alert-info">
                        <div class="fw-bold">æ£€æµ‹ç»“æœç»Ÿè®¡ï¼š</div>
                        <div>æ€»è®¡: ${lastResults.length} ä¸ªä»¤ç‰Œ</div>
                        <div>æœ‰æ•ˆ: ${validCount} ä¸ª</div>
                        <div>æ— æ•ˆ: ${lastResults.length - validCount} ä¸ª</div>
                    </div>
                `;

                lastResults.forEach((result, index) => {
                    const card = document.createElement('div');
                    card.className = `result-card ${result.status === 'valid' ? 'success' : 'error'}`;
                    const num = (index + 1).toString().padStart(3, ' ');
                    const displayToken = tokens[index] === '' ? '(ç©ºè¡Œ)' : tokens[index];
                    card.innerHTML = `
                        <div class="fw-bold">åºå· ${num}. ${displayToken}</div>
                        <div>çŠ¶æ€: ${result.status === 'valid' ? 'æœ‰æ•ˆ' : 'æ— æ•ˆ'}</div>
                        <div>æ¶ˆæ¯: ${result.message}</div>
                        ${result.status === 'valid' ? `
                            <div class="mt-2">
                                <button class="btn btn-sm btn-outline-primary" onclick="copy('${result.access_token}')">
                                    å¤åˆ¶ Access Token
                                </button>
                            </div>
                        ` : ''}
                    `;
                    results.appendChild(card);
                });
            } catch (error) {
                results.innerHTML = `
                    <div class="alert alert-danger">
                        æ£€æµ‹å¤±è´¥: ${error.message}
                    </div>
                `;
            } finally {
                loading.style.display = 'none';
            }
        });

        document.getElementById('copyValidRTButton').addEventListener('click', () => {
            if (!lastResults.length) return alert('è¯·å…ˆè¿›è¡Œæ£€æµ‹ï¼');
            const validRTs = lastResults
                .filter(r => r.status === 'valid')
                .map(r => r.refresh_token)
                .join('\n');
            if (!validRTs) return alert('æ²¡æœ‰æ‰¾åˆ°æœ‰æ•ˆçš„RTï¼');
            copy(validRTs);
        });

        document.getElementById('copyValidATButton').addEventListener('click', () => {
            if (!lastResults.length) return alert('è¯·å…ˆè¿›è¡Œæ£€æµ‹ï¼');
            const validATs = lastResults
                .filter(r => r.status === 'valid')
                .map(r => r.access_token)
                .join('\n');
            if (!validATs) return alert('æ²¡æœ‰æ‰¾åˆ°æœ‰æ•ˆçš„ATï¼');
            copy(validATs);
        });

        // ä¿®æ”¹æ˜¾ç¤ºæç¤ºçš„æ—¶é—´ä¸º5ç§’
        document.addEventListener('DOMContentLoaded', () => {
            const notice = document.getElementById('notice');
            notice.style.display = 'block';
            
            // 5ç§’åè‡ªåŠ¨éšè—
            setTimeout(() => {
                notice.style.display = 'none';
            }, 5000);  // ä»4000æ”¹ä¸º5000æ¯«ç§’
        });

        // åœ¨é¡µé¢åˆ·æ–°æ—¶ä¹Ÿæ˜¾ç¤ºæç¤º
        window.addEventListener('beforeunload', () => {
            const notice = document.getElementById('notice');
            notice.style.display = 'block';
        });

        // ä¿®æ”¹åˆå§‹åŒ–å¤‡å¿˜å½•æ•°æ®çš„éƒ¨åˆ†
        const DEFAULT_MEMOS = [
            {
                id: 1,
                title: 'è´¦å·å¯†ç ',
                content: '',
                timestamp: new Date().toISOString(),
                isExpanded: false,
                isDetailsVisible: false
            },
            {
                id: 2,
                title: 'RT',
                content: '',
                timestamp: new Date().toISOString(),
                isExpanded: false,
                isDetailsVisible: false
            },
            {
                id: 3,
                title: 'AT',
                content: '',
                timestamp: new Date().toISOString(),
                isExpanded: false,
                isDetailsVisible: false
            }
        ];

        // åˆå§‹åŒ–å¤‡å¿˜å½•æ•°æ®
        let memos = JSON.parse(localStorage.getItem('memos') || JSON.stringify(DEFAULT_MEMOS));

        // ç¡®ä¿é»˜è®¤å¤‡å¿˜å½•å­˜åœ¨
        if (!memos.some(memo => memo.id === 1)) {
            memos.push(DEFAULT_MEMOS[0]);
        }
        if (!memos.some(memo => memo.id === 2)) {
            memos.push(DEFAULT_MEMOS[1]);
        }
        if (!memos.some(memo => memo.id === 3)) {
            memos.push(DEFAULT_MEMOS[2]);
        }

        // ä¿®æ”¹æ¸…é™¤æ‰€æœ‰å¤‡å¿˜çš„å‡½æ•°
        function clearAllMemos() {
            if (memos.length === 0) {
                alert('æ²¡æœ‰å¯æ¸…é™¤çš„å¤‡å¿˜ï¼');
                return;
            }
            
            if (confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰å¤‡å¿˜å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
                // é‡ç½®ä¸ºé»˜è®¤çš„ä¸‰ä¸ªå¤‡å¿˜å½•
                memos = JSON.parse(JSON.stringify(DEFAULT_MEMOS));
                localStorage.setItem('memos', JSON.stringify(memos));
                renderMemos();
                alert('æ‰€æœ‰å¤‡å¿˜å·²æ¸…é™¤ï¼');
            }
        }

        // ä¿®æ”¹æ·»åŠ æ–°å¤‡å¿˜çš„å‡½æ•°
        function addMemo() {
            const newMemo = {
                id: Math.max(...memos.map(m => m.id), 0) + 1, // ç¡®ä¿IDä¸é‡å¤
                title: '',
                content: '',
                timestamp: new Date().toISOString(),
                isExpanded: false,
                isDetailsVisible: false
            };
            memos.unshift(newMemo);
            saveMemos();
            renderMemos();
            // æ·»åŠ åè‡ªåŠ¨å±•å¼€æ–°å¤‡å¿˜
            setTimeout(() => {
                toggleMemoDetails(newMemo.id);
            }, 100);
        }

        // ä¿®æ”¹åˆ é™¤å¤‡å¿˜çš„å‡½æ•°
        function deleteMemo(id) {
            // æ£€æŸ¥æ˜¯å¦æ˜¯é»˜è®¤å¤‡å¿˜å½•
            if (id <= 3) {
                alert('é»˜è®¤å¤‡å¿˜å½•ä¸èƒ½åˆ é™¤ï¼');
                return;
            }
            
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡å¤‡å¿˜å—ï¼Ÿ')) {
                memos = memos.filter(memo => memo.id !== id);
                saveMemos();
                renderMemos();
            }
        }

        // ä¿®æ”¹æ¸²æŸ“å‡½æ•°
        function renderMemos() {
            const memoList = document.getElementById('memoList');
            memoList.innerHTML = memos.map(memo => `
                <div class="memo-item">
                    <div class="memo-header" style="cursor: pointer;">
                        <div class="memo-preview" onclick="toggleMemoDetails(${memo.id}, event)">
                            ${memo.title || '(æ— æ ‡é¢˜)'}
                            <span class="memo-time ms-2 text-muted">
                                ${new Date(memo.timestamp).toLocaleString()}
                            </span>
                        </div>
                        <div class="d-flex align-items-center gap-2">
                            <button class="btn btn-success btn-sm px-4" 
                                    style="position: absolute; left: 50%; transform: translateX(-50%);" 
                                    onclick="saveMemoContent(${memo.id}, event)">
                                ä¿å­˜
                            </button>
                            <span class="text-muted" style="margin-left: auto;" onclick="toggleMemoDetails(${memo.id}, event)">
                                <i class="fas fa-chevron-down ${memo.isDetailsVisible ? 'rotated' : ''}"></i>
                            </span>
                        </div>
                    </div>
                    <div class="memo-details ${memo.isDetailsVisible ? 'expanded' : ''}" style="display: ${memo.isDetailsVisible ? 'block' : 'none'}">
                        <input type="text" 
                            id="memo-title-${memo.id}"
                            class="form-control mb-2"
                            placeholder="è¾“å…¥æ ‡é¢˜..."
                            value="${memo.title}"
                            oninput="autoSaveMemo(${memo.id})"
                        />
                        <div class="memo-content-container">
                            <div class="memo-line-numbers" id="memo-line-numbers-${memo.id}"></div>
                            <textarea id="memo-content-${memo.id}" 
                                class="form-control memo-content" 
                                placeholder="åœ¨æ­¤è¾“å…¥å¤‡å¿˜å†…å®¹..."
                                oninput="updateMemoLineNumbers(${memo.id}); autoSaveMemo(${memo.id})"
                                onscroll="syncMemoScroll(${memo.id})"
                            >${memo.content}</textarea>
                        </div>
                        <div class="memo-actions">
                            <button class="btn btn-info btn-sm" onclick="copyMemoContent(${memo.id})">
                                å¤åˆ¶
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="deleteMemo(${memo.id})">
                                åˆ é™¤
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');

            // åˆå§‹åŒ–æ‰€æœ‰å¯è§å¤‡å¿˜å½•çš„è¡Œå·
            memos.forEach(memo => {
                if (memo.isDetailsVisible) {
                    updateMemoLineNumbers(memo.id);
                }
            });
        }

        // é¡µé¢åŠ è½½æ—¶æ¸²æŸ“å¤‡å¿˜å½•
        document.addEventListener('DOMContentLoaded', () => {
            renderMemos();
        });

        // æ·»åŠ å¤‡å¿˜å½•å®¹å™¨åˆ‡æ¢å‡½æ•°
        function toggleMemoContainer() {
            const container = document.getElementById('memoContainer');
            const button = document.getElementById('toggleMemoButton');
            const isHidden = container.style.display === 'none';
            
            if (isHidden) {
                container.style.display = 'block';
                setTimeout(() => {
                    container.classList.add('show');
                    button.classList.add('active');
                }, 10);
            } else {
                container.classList.remove('show');
                button.classList.remove('active');
                setTimeout(() => {
                    container.style.display = 'none';
                }, 300);
            }
        }

        // æ·»åŠ æ›´æ–°å¤‡å¿˜å½•è¡Œå·çš„å‡½æ•°
        function updateMemoLineNumbers(id) {
            const textarea = document.getElementById(`memo-content-${id}`);
            const lineNumbers = document.getElementById(`memo-line-numbers-${id}`);
            if (!textarea || !lineNumbers) return;

            const lines = textarea.value.split('\n');
            const numbers = lines.map((_, i) => `${i + 1}`).join('\n');
            lineNumbers.textContent = numbers;
        }

        // æ·»åŠ åŒæ­¥æ»šåŠ¨çš„å‡½æ•°
        function syncMemoScroll(id) {
            const textarea = document.getElementById(`memo-content-${id}`);
            const lineNumbers = document.getElementById(`memo-line-numbers-${id}`);
            if (!textarea || !lineNumbers) return;

            lineNumbers.scrollTop = textarea.scrollTop;
        }

        // æ·»åŠ ä¸»åŠ¨ä¿å­˜å‡½æ•°
        function saveMemoContent(id, event) {
            if (event) {
                event.stopPropagation();
            }
            const titleElement = document.getElementById(`memo-title-${id}`);
            const contentElement = document.getElementById(`memo-content-${id}`);
            
            if (!titleElement || !contentElement) return;
            
            const title = titleElement.value.trim();
            const content = contentElement.value.trim();
            
            memos = memos.map(memo => {
                if (memo.id === id) {
                    return {
                        ...memo,
                        title,
                        content,
                        timestamp: new Date().toISOString()
                    };
                }
                return memo;
            });
            saveMemos();
            renderMemos();
            alert('ä¿å­˜æˆåŠŸï¼');
        }

        // æ·»åŠ å¤±å»ç„¦ç‚¹æ—¶è‡ªåŠ¨ä¿å­˜
        document.addEventListener('click', (e) => {
            const memoContainer = document.getElementById('memoContainer');
            if (memoContainer && !memoContainer.contains(e.target)) {
                // ç‚¹å‡»å¤‡å¿˜å½•å®¹å™¨å¤–éƒ¨æ—¶ï¼Œä¿å­˜æ‰€æœ‰æ‰“å¼€çš„å¤‡å¿˜å½•
                memos.forEach(memo => {
                    if (memo.isDetailsVisible) {
                        const titleElement = document.getElementById(`memo-title-${memo.id}`);
                        const contentElement = document.getElementById(`memo-content-${memo.id}`);
                        if (titleElement && contentElement) {
                            const title = titleElement.value.trim();
                            const content = contentElement.value.trim();
                            memo.title = title;
                            memo.content = content;
                            memo.timestamp = new Date().toISOString();
                        }
                    }
                });
                saveMemos();
                renderMemos();
            }
        });

        // é¡µé¢å…³é—­å‰ä¿å­˜
        window.addEventListener('beforeunload', () => {
            memos.forEach(memo => {
                if (memo.isDetailsVisible) {
                    const titleElement = document.getElementById(`memo-title-${memo.id}`);
                    const contentElement = document.getElementById(`memo-content-${memo.id}`);
                    if (titleElement && contentElement) {
                        const title = titleElement.value.trim();
                        const content = contentElement.value.trim();
                        memo.title = title;
                        memo.content = content;
                        memo.timestamp = new Date().toISOString();
                    }
                }
            });
            saveMemos();
        });

        // æ·»åŠ ä¿å­˜å¤‡å¿˜å½•åˆ°æœ¬åœ°å­˜å‚¨çš„å‡½æ•°
        function saveMemos() {
            localStorage.setItem('memos', JSON.stringify(memos));
        }

        // æ·»åŠ åˆ‡æ¢å¤‡å¿˜å½•è¯¦æƒ…çš„å‡½æ•°
        function toggleMemoDetails(id, event) {
            if (event) {
                event.stopPropagation();
            }
            memos = memos.map(memo => {
                if (memo.id === id) {
                    return {
                        ...memo,
                        isDetailsVisible: !memo.isDetailsVisible
                    };
                }
                return memo;
            });
            saveMemos();
            renderMemos();
            
            // å¦‚æœæ˜¯å±•å¼€çŠ¶æ€ï¼Œåˆå§‹åŒ–è¡Œå·
            const memo = memos.find(m => m.id === id);
            if (memo && memo.isDetailsVisible) {
                setTimeout(() => {
                    updateMemoLineNumbers(id);
                }, 100);
            }
        }

        // ä¿®æ”¹è‡ªåŠ¨ä¿å­˜å‡½æ•°çš„æ—¶é—´ä¸º2ç§’
        function autoSaveMemo(id) {
            clearTimeout(autoSaveTimeout);
            autoSaveTimeout = setTimeout(() => {
                const titleElement = document.getElementById(`memo-title-${id}`);
                const contentElement = document.getElementById(`memo-content-${id}`);
                
                if (!titleElement || !contentElement) return;
                
                const title = titleElement.value.trim();
                const content = contentElement.value.trim();
                
                memos = memos.map(memo => {
                    if (memo.id === id) {
                        return {
                            ...memo,
                            title,
                            content,
                            timestamp: new Date().toISOString()
                        };
                    }
                    return memo;
                });
                saveMemos();
                renderMemos();
            }, 2000); // æ”¹ä¸º2000æ¯«ç§’
        }
    </script>
</body>
</html> 
